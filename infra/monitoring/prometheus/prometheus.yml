# =============================================================================
# Prometheus Configuration - Temporal Workflow Monitoring
# =============================================================================
# This configuration scrapes metrics from:
# - Temporal Server (direct Prometheus endpoint)
# - Temporal Workers (via OpenTelemetry Collector)
# - OpenTelemetry Collector itself
# - Optional: Express/application server metrics
# =============================================================================

global:
  scrape_interval: 15s
  scrape_timeout: 10s
  evaluation_interval: 15s
  
  external_labels:
    cluster: 'temporal-dev'
    environment: 'development'

# =============================================================================
# Alerting Configuration
# =============================================================================
alerting:
  alertmanagers:
    - static_configs:
        - targets: []
          # Add alertmanager targets here when ready
          # - targets: ['alertmanager:9093']

# =============================================================================
# Rules Files
# =============================================================================
rule_files:
  - "/etc/prometheus/alerts/*.yml"
  # Add your alerting rules here

# =============================================================================
# Scrape Configurations
# =============================================================================
scrape_configs:
  # ---------------------------------------------------------------------------
  # Temporal Server Metrics
  # Direct Prometheus endpoint from Temporal server
  # ---------------------------------------------------------------------------
  - job_name: 'temporal-server'
    honor_labels: true
    honor_timestamps: true
    
    static_configs:
      - targets: ['temporal:9090']
        labels:
          service: 'temporal'
          component: 'server'
    
    scrape_interval: 10s
    scrape_timeout: 5s
    metrics_path: '/metrics'
    
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'temporal_.*'
        action: keep

  # ---------------------------------------------------------------------------
  # Temporal Worker Metrics
  # Collected via OpenTelemetry Collector and exposed on port 9464
  # ---------------------------------------------------------------------------
  - job_name: 'temporal-workers'
    honor_labels: true
    honor_timestamps: true
    
    static_configs:
      - targets: ['otel-collector:9464']
        labels:
          service: 'temporal'
          component: 'worker'
    
    scrape_interval: 10s
    scrape_timeout: 5s
    metrics_path: '/metrics'
    
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):.*'
        replacement: '$1'
      
      - source_labels: [service_name]
        target_label: worker_service
        action: replace

  # ---------------------------------------------------------------------------
  # OpenTelemetry Collector Metrics
  # Self-monitoring metrics from the OTEL collector
  # ---------------------------------------------------------------------------
  - job_name: 'otel-collector'
    honor_labels: true
    
    static_configs:
      - targets: ['otel-collector:8888']
        labels:
          service: 'otel-collector'
          component: 'collector'
    
    scrape_interval: 30s
    scrape_timeout: 10s
    metrics_path: '/metrics'

  # ---------------------------------------------------------------------------
  # Prometheus Self-Monitoring
  # ---------------------------------------------------------------------------
  - job_name: 'prometheus'
    honor_labels: true
    
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'
          component: 'monitoring'
    
    scrape_interval: 30s
    metrics_path: '/metrics'

  # ---------------------------------------------------------------------------
  # PostgreSQL Exporter (Optional - uncomment if using postgres_exporter)
  # ---------------------------------------------------------------------------
  # - job_name: 'postgres'
  #   honor_labels: true
  #   
  #   static_configs:
  #     - targets: ['postgres-exporter:9187']
  #       labels:
  #         service: 'postgresql'
  #         component: 'database'
  #   
  #   scrape_interval: 30s
  #   metrics_path: '/metrics'

  # ---------------------------------------------------------------------------
  # Application Server Metrics (Optional)
  # Uncomment if your Express/application server exposes metrics
  # ---------------------------------------------------------------------------
  # - job_name: 'application-server'
  #   honor_labels: true
  #   
  #   static_configs:
  #     - targets: ['host.docker.internal:3000']
  #       labels:
  #         service: 'application'
  #         component: 'api-server'
  #   
  #   scrape_interval: 15s
  #   scrape_timeout: 5s
  #   metrics_path: '/metrics'
  #   
  #   relabel_configs:
  #     - source_labels: [__address__]
  #       target_label: instance
  #       regex: '([^:]+):.*'
  #       replacement: '$1'

# =============================================================================
# Remote Write Configuration (Optional)
# =============================================================================
# remote_write:
#   - url: "http://remote-prometheus:9090/api/v1/write"
#     queue_config:
#       capacity: 10000
#       max_shards: 10
#       min_shards: 1
#       max_samples_per_send: 5000
#       batch_send_deadline: 5s
#       min_backoff: 30ms
#       max_backoff: 100ms

# =============================================================================
# Storage Configuration
# =============================================================================
# Storage configuration is set via command-line flags in docker-compose.yml:
# - --storage.tsdb.retention.time=30d
# - --storage.tsdb.retention.size=10GB

